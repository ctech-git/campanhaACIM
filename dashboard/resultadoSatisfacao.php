<!doctype html>
<html class="no-js" lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Satisfação</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <!-- favicon
  ============================================ -->
  <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
  <!-- Google Fonts
  ============================================ -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,700,900" rel="stylesheet">
  <!-- Bootstrap CSS
  ============================================ -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Bootstrap CSS
  ============================================ -->
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <!-- owl.carousel CSS
  ============================================ -->
  <link rel="stylesheet" href="css/owl.carousel.css">
  <link rel="stylesheet" href="css/owl.theme.css">
  <link rel="stylesheet" href="css/owl.transitions.css">
  <!-- animate CSS
  ============================================ -->
  <link rel="stylesheet" href="css/animate.css">
  <!-- normalize CSS
  ============================================ -->
  <link rel="stylesheet" href="css/normalize.css">
  <!-- meanmenu icon CSS
  ============================================ -->
  <link rel="stylesheet" href="css/meanmenu.min.css">
  <!-- main CSS
  ============================================ -->
  <link rel="stylesheet" href="css/main.css">
  <!-- educate icon CSS
  ============================================ -->
  <link rel="stylesheet" href="css/educate-custon-icon.css">
  <!-- morrisjs CSS
  ============================================ -->
  <link rel="stylesheet" href="css/morrisjs/morris.css">
  <!-- mCustomScrollbar CSS
  ============================================ -->
  <link rel="stylesheet" href="css/scrollbar/jquery.mCustomScrollbar.min.css">
  <!-- metisMenu CSS
  ============================================ -->
  <link rel="stylesheet" href="css/metisMenu/metisMenu.min.css">
  <link rel="stylesheet" href="css/metisMenu/metisMenu-vertical.css">
  <!-- calendar CSS
  ============================================ -->
  <link rel="stylesheet" href="css/calendar/fullcalendar.min.css">
  <link rel="stylesheet" href="css/calendar/fullcalendar.print.min.css">
  <!-- forms CSS
  ============================================ -->
  <link rel="stylesheet" href="css/form/all-type-forms.css">
  <!-- dropzone CSS
  ============================================ -->
  <link rel="stylesheet" href="css/dropzone/dropzone.css">
  <!-- style CSS
  ============================================ -->
  <link rel="stylesheet" href="style.css">
  <!-- responsive CSS
  ============================================ -->
  <link rel="stylesheet" href="css/responsive.css">
  <!-- modernizr JS
  ============================================ -->
  <script src="js/vendor/modernizr-2.8.3.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.6/css/responsive.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/rowreorder/1.2.7/css/rowReorder.dataTables.min.css">


</head>

<body>
  <!--[if lt IE 8]>
  <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
  <![endif]-->
  <!-- Start Left menu area -->

  <!-- End Left menu area -->
  <!-- Start Welcome area -->
  <div class="all-content-wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <div class="logo-pro">
            <a href="index.html"><img style='width:150px' class="main-logo" src="img/logo/logo.png" alt="" /></a>
          </div>
        </div>
      </div>
    </div>
    <!-- Single pro tab review Start-->
    <div class="single-pro-review-area mt-t-30 mg-b-15">
      <div class="container-fluid">
        <div class="row">

          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div class="product-payment-inner-st res-mg-t-30 analysis-progrebar-ctn">
              <ul id="myTabedu1" class="tab-review-design">
                <li class="active"><a href="#reviews">Resultado das pesquisas</a></li>
                <li><a href="#aniversariantes">Aniversariantes da semana</a></li>
                <!-- <li><a href="#description">Análise</a></li>
                <li><a href="#INFORMATION">Atualizar dados</a></li> -->
              </ul>
              <div id="myTabContent" class="tab-content custom-product-edit st-prf-pro">
                <div class="product-tab-list tab-pane active" id="reviews">
                  <div class="row" id='graficos'>

                  </div>

                  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style='margin-top:50px'>
                    <table id='relatorioClientes' class='display nowrap' style='margin: 0px !important; width: 100%'>
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>Nome</th>
                          <th>Telefone</th>
                          <th>Aniversário</th>
                          <th style="width:20%">Observações</th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>


                </div>
                <div class="product-tab-list tab-pane" id="aniversariantes">
                  <div class="row" id='aniversarioDoMes'>



                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-copyright-area">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-12">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- jquery
        ============================================ -->
  <script src="js/vendor/jquery-1.12.4.min.js"></script>
  <!-- bootstrap JS
        ============================================ -->
  <script src="js/bootstrap.min.js"></script>
  <!-- wow JS
        ============================================ -->
  <script src="js/wow.min.js"></script>
  <!-- price-slider JS
        ============================================ -->
  <script src="js/jquery-price-slider.js"></script>
  <!-- meanmenu JS
        ============================================ -->
  <script src="js/jquery.meanmenu.js"></script>
  <!-- owl.carousel JS
        ============================================ -->
  <script src="js/owl.carousel.min.js"></script>
  <!-- sticky JS
        ============================================ -->
  <script src="js/jquery.sticky.js"></script>
  <!-- scrollUp JS
        ============================================ -->
  <script src="js/jquery.scrollUp.min.js"></script>
  <!-- mCustomScrollbar JS
        ============================================ -->
  <script src="js/scrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/scrollbar/mCustomScrollbar-active.js"></script>
  <!-- metisMenu JS
        ============================================ -->
  <script src="js/metisMenu/metisMenu.min.js"></script>
  <script src="js/metisMenu/metisMenu-active.js"></script>
  <!-- morrisjs JS
        ============================================ -->
  <script src="js/sparkline/jquery.sparkline.min.js"></script>
  <script src="js/sparkline/jquery.charts-sparkline.js"></script>
  <!-- calendar JS
        ============================================ -->
  <script src="js/calendar/moment.min.js"></script>
  <script src="js/calendar/fullcalendar.min.js"></script>
  <script src="js/calendar/fullcalendar-active.js"></script>
  <!-- tab JS
        ============================================ -->
  <script src="js/tab.js"></script>
  <!-- plugins JS
        ============================================ -->
  <script src="js/plugins.js"></script>
  <!-- main JS
        ============================================ -->
  <script src="js/main.js"></script>
  <script src="js_nova/relatorio_gerencial.js"></script>


  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.flash.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.6/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/rowreorder/1.2.7/js/dataTables.rowReorder.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

  <!-- tawk chat JS
        ============================================ -->
</body>

</html>
<script>
var perguntas = [];


$(document).ready(function() {
  buscar_formulario();
});

function buscar_formulario() {

  var url_string = window.location;
  var url = new URL(url_string);

  var id = url.searchParams.get("id");

  buscar_resultados(id);
}

function buscar_resultados(id) {
  $.ajax({
    url: 'Control/ler_empresa.php',
    dataType: 'json',
    async: false,
    destroy: true,

    data: {
      id
    },
    success: function(data) {

      perguntas = data[0].perguntas;
      buscar_respostas(id);

    }
  });
}

function buscar_respostas(id) {

  $.ajax({
    url: 'Control/ler_respostas.php',
    dataType: 'json',
    destroy: true,
    data: {
      id
    },
    success: function(data) {
      gerarGraficos(data);
      gerarObservacoes(data);
      gerarAniversarios(data);
    }
  });
}

function gerarObservacoes(data) {

  var table = $('#relatorioClientes').DataTable();
  table.clear().draw();
  table.destroy();
  var t = $('#relatorioClientes').DataTable({
    'paging': true,
    'info': false,
    "scrollX": true,
    "order": [
      [0, "desc"]
    ],
    dom: 'Bfrtip',
    buttons: [
      'copyHtml5',
      'excelHtml5',
      'csvHtml5',
      'pdfHtml5'
    ],
    "autoWidth": false,
    "language": {
      "url": "https://cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Portuguese-Brasil.json"
    },
  });

  for (let i = 0; i < data.length; i++) {
    const element = data[i];
    var observacao = element.observacoes;
    var nome = element.nome;
    var telefone = element.telefone;
    var dataNascimento = element.dataNascimento;
    var createdAt = element.createdAt;
    createdAt = formatarDataHora(createdAt);

    var whatsapp = telefone.replaceAll('(', '');
    whatsapp = whatsapp.replaceAll(')', '');
    whatsapp = whatsapp.replaceAll(' ', '');
    whatsapp = whatsapp.replaceAll('-', '');
    var link = `<a href='https://wa.me/55${whatsapp}'>${telefone}</a>`;

    t.row.add([
      createdAt,
      nome,
      link,
      dataNascimento,
      observacao
    ]);

  }
}

function gerarGraficos(data) {
  perguntas = JSON.parse(perguntas)
  for (var i = 0; i < perguntas.length; i++) {

    var texto_pergunta = perguntas[i];
    var array = [];

    for (var j = 0; j < data.length; j++) {
      var respostas = data[j].respostas;

      if (respostas) {
        respostas = JSON.parse(respostas)
        var resposta_selecionada = respostas[i];
        array.push(resposta_selecionada);
      }

    }
    grafico(texto_pergunta, array);
  }
}

function formatarDataHora(data) {
  var timestamp = data;

  data = data.split(' ');
  var horas = data[1];
  data = data[0];
  data = data.split('-');
  data = '<span style="display:none">' + timestamp + '</span>' + data[2] + '/' + data[1] + '/' + data[0] + ' ' + horas;

  return data;

}

function grafico(texto_pergunta, array) {

  setTimeout(() => {
    var d = new Date();
    var id_div = d.getTime();
    $('#graficos').append(` <div class = "col-lg-6 col-md-6 col-sm-12 col-xs-12" >
  <canvas id = "${id_div}"> </canvas> </div>
  `);

    var otimo = 0;
    var normal = 0;
    var ruim = 0;
    var pessimo = 0;
    var bom = 0;

    array.map(function(item, indice) {
      var dado = item;
      if (dado == 1 || dado == "1") {
        otimo++
      }
      if (dado == 2 || dado == "2") {
        bom++
      }
      if (dado == 3 || dado == "3") {
        normal++
      }
      if (dado == 4 || dado == "4") {
        ruim++
      }
      if (dado == 5 || dado == "5") {
        pessimo++
      }
    });


    console.log(otimo);
    console.log(normal);
    console.log(ruim);

    new Chart(document.getElementById(id_div), {
      type: 'pie',
      data: {
        labels: ["Ótimo", "Bom", "Normal", "Ruim", "Péssimo"],
        datasets: [{
          label: 'Respostas',
          backgroundColor: ["#3e95cd", "#8e5ea2", "#3cba9f", "#e8c3b9", "#c45850"],
          data: [otimo, bom, normal, ruim, pessimo]
        }]
      },
      options: {
        responsive: false,
        title: {
          display: true,
          text: texto_pergunta
        }
      }
    });
  }, 100);

}

function gerarAniversarios(data) {

  var aniversarios = [];
  var d = new Date();
  var mes_atual = d.getMonth() + 1;

  for (let i = 0; i < data.length; i++) {
    const element = data[i];
    var dataNascimento = element.dataNascimento;
    var nome = element.nome;
    var telefone = element.telefone;

    var mes = dataNascimento.split('/');
    var dia = mes[0];
    var ano = mes[2];
    mes = mes[1];

    if (mes == mes_atual) {
      aniversarios.push({
        'mes': mes,
        'dia': dia,
        'ano': ano,
        'nome': nome,
        'telefone': telefone
      })
    }

  }
  gerarLista(aniversarios);
}

function gerarLista(aniversarios) {
  aniversarios.map(function(item, indice) {

    var dia = item.dia + '/' + item.mes + '/' + item.ano;

    $('#aniversarioDoMes').append(`
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12" onclick="enviarMensagem('${item.nome}','${item.telefone}','${item.ano}')">
                        <div class="hpanel widget-int-shape responsive-mg-b-30">
                            <div class="panel-body">
                                <div class="stats-title pull-left">
                                    <h4>${item.nome}</h4>
                                </div>
                                <div class="stats-icon pull-right">
                                    <i class="educate-icon educate-professor"></i>
                                </div>
                                <div class="m-t-xl widget-cl-2">
                                    <h1 class="text-info">${dia}</h1>
                                    <small>
												Clique aqui para enviar uma mensagem!
											</small>
                                </div>
                            </div>
                        </div>
                    </div>
        `);

  });
}

function enviarMensagem(nome, telefone, ano) {
  var d = new Date();
  var anoAtual = d.getFullYear();
  var somatoria = Number(anoAtual) - Number(ano);
  console.log(telefone);
  telefone = telefone.replace('(', '');
  telefone = telefone.replace(')', '');
  telefone = telefone.replace('-', '');
  telefone = telefone.replace(' ', '');
  telefone = telefone.replace(' ', '');
  console.log(telefone);

  var texto = `E aííí, ${nome}!
Vimos que você está fazendo ${somatoria} anos essa semana! 🥳 
Venha comemorar essa data tão especial conosco ☺️ A Barredo’s lhe deseja um feliz aniversário e lhe oferece nesse dia, *uma porção de fritas por conta da casa!* Lhe aguardamos aqui❗️

Ass: Jeff Barredo 🤠`;
  texto = encodeURI(texto);
  var url = `https://wa.me/55${telefone}?text=${texto}`;

  var a = document.createElement('a');
  a.target = "_blank";
  a.href = url;
  a.click();
}
</script>